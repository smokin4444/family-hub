<script>
    const DB_URL = 'https://script.google.com/macros/s/AKfycbxfcQoQCWnlbfOX8jIJKLAuc8VuWknXYQ5WQSKZhXywoHQRub91tyS6gRPBKqFrn01bWg/exec';
    const family = { kids: ['Ellie', 'Joey', 'Madi'], adults: ['Mum', 'Dad', 'Snickers'] };
    const mColors = { Ellie: '#e5ccff', Joey: '#cce5ff', Madi: '#ffcceb', Mum: '#c9e4d1', Dad: '#d9f2f2', Snickers: '#d7b899' };
    const hColors = { Ellie: 'var(--ellie-h)', Joey: 'var(--joey-h)', Madi: 'var(--madi-h)', Mum: 'var(--mum-h)', Dad: 'var(--dad-h)', Snickers: 'var(--snickers-h)' };
    const bgColors = { Ellie: 'var(--ellie-bg)', Joey: 'var(--joey-bg)', Madi: 'var(--madi-bg)', Mum: 'var(--mum-bg)', Dad: 'var(--dad-bg)', Snickers: 'var(--snickers-bg)' };
    
    let chores = [], term = [], curM = 'Ellie', cPage = 'kids', currentTab = 'week', dateOffset = 0;

    // THE RESTORED RESET LOGIC
    function resetDaily() {
        if (confirm("Reset all chores to 'not done' for today?")) {
            chores.forEach(c => c.done = false);
            render();
            cloudSave();
            toggleOverlay(false);
        }
    }

    // UPDATED OVERLAY (Ensuring the Reset button is visible and works)
    function toggleOverlay(s) {
        const overlay = document.getElementById('overlay');
        overlay.style.display = s ? 'flex' : 'none';
        
        document.getElementById('overlay-title').textContent = (currentTab === 'chores') ? 'Add New Chore' : 'Add Term Event';
        
        // Show/Hide Reset button - only makes sense for chores
        const resetBtn = document.getElementById('reset-action-btn');
        if (resetBtn) resetBtn.style.display = (currentTab === 'chores') ? 'block' : 'none';

        const sel = document.getElementById('member-select-overlay');
        sel.innerHTML = '';
        if(currentTab === 'chores') {
            [...family.kids, ...family.adults].forEach(m => {
                const b = document.createElement('button');
                b.className = `m-btn ${curM===m?'active':''}`;
                b.textContent = m;
                b.onclick = () => { 
                    curM=m; 
                    document.querySelectorAll('.m-btn').forEach(x => x.classList.remove('active')); 
                    b.classList.add('active'); 
                };
                sel.appendChild(b);
            });
        }
    }

    // UI Structure for the buttons inside the overlay
    function updateOverlayButtons() {
        const card = document.querySelector('.overlay-card div[style*="display:flex; gap:10px"]');
        card.innerHTML = `
            <button onclick="addItem()" style="flex:2; background:#82c91e; color:white; border:none; padding:15px; border-radius:12px; font-weight:800; font-size:16px;">Add</button>
            <button id="reset-action-btn" onclick="resetDaily()" style="flex:1; background:#f0ad4e; color:white; border:none; padding:12px; border-radius:12px; font-weight:800; font-size:12px;">Reset Day</button>
            <button onclick="toggleOverlay(false)" style="flex:1; background:#ccc; border:none; padding:12px; border-radius:12px; font-weight:800;">Close</button>
        `;
    }

    // Standard CRUD functions
    async function cloudSave() { try { await fetch(DB_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ chores: JSON.stringify(chores), term: JSON.stringify(term) }) }); } catch(e) {} }
    
    async function cloudLoad() {
        try {
            const r = await fetch(DB_URL);
            const d = await r.json();
            chores = JSON.parse(d.chores || '[]');
            term = JSON.parse(d.term || '[]');
            render();
        } catch(e) {}
    }

    function render() {
        const grid = document.getElementById('chores-grid'); if(!grid) return;
        grid.innerHTML = '';
        family[cPage].forEach(m => {
            const list = chores.filter(c => c.person === m);
            const done = list.filter(c => c.done).length, total = list.length;
            const perc = total > 0 ? (done/total)*100 : 0;
            const col = document.createElement('div');
            col.className = 'chore-col'; col.style.backgroundColor = bgColors[m];
            col.innerHTML = `<div class="col-header" style="background:${hColors[m]}">${m === 'Snickers' ? 'üêæ ' : ''}${m}</div>
                <div class="progress-container"><div class="progress-fill" style="width:${perc}%"></div></div>
                <div class="chore-list" id="l-${m}"></div>`;
            grid.appendChild(col);
            list.forEach(c => {
                const item = document.createElement('div'); 
                item.className = `chore-item ${c.done?'done':''}`;
                item.style.borderLeft = `8px solid ${mColors[m]}`;
                item.innerHTML = `<span onclick="toggleItem('${c.id}')" style="flex:1;">${c.text}</span><span onclick="deleteItem('${c.id}')" style="color:#ccc">‚úï</span>`;
                document.getElementById('l-'+m).appendChild(item);
            });
        });

        const tList = document.getElementById('term-list'); if(!tList) return;
        tList.innerHTML = '';
        term.forEach((t, i) => {
            const item = document.createElement('div'); 
            item.className = 'chore-item'; 
            item.style.borderLeft = '8px solid var(--header-green)';
            item.innerHTML = `<span>${t}</span><span onclick="deleteTerm(${i})" style="color:#ccc">‚úï</span>`;
            tList.appendChild(item);
        });
    }

    function addItem() {
        const val = document.getElementById('new-input').value; 
        if(!val) return; 
        if(currentTab === 'chores') chores.push({id: 'u-'+Date.now(), text: val, person: curM, done: false}); 
        else term.push(val); 
        document.getElementById('new-input').value = ''; 
        toggleOverlay(false); render(); cloudSave(); 
    }

    function toggleItem(id) { const c = chores.find(x => x.id === id); c.done = !c.done; render(); cloudSave(); }
    function deleteItem(id) { if(confirm("Delete chore?")) { chores = chores.filter(x => x.id !== id); render(); cloudSave(); } }
    function deleteTerm(i) { if(confirm("Delete term item?")) { term.splice(i, 1); render(); cloudSave(); } }
    function setCP(p) { cPage = p; render(); document.querySelectorAll('#p-kids, #p-adults').forEach(b => b.classList.toggle('active', b.id.includes(p))); }
    function changeWeek(days) { dateOffset += days; updateCals(); }

    function updateCals() {
        const d = new Date(); d.setDate(d.getDate() + dateOffset);
        const ds = d.toISOString().split('T')[0].replace(/-/g, '');
        const p = `&showTitle=0&showNav=0&showDate=1&showTabs=0&showPrint=0&showCalendars=0&ctz=Australia/Melbourne&dates=${ds}/${ds}`;
        const src = `&src=joesita@gmail.com&color=%230B8043&src=bethanyrileysita@gmail.com&color=%23E67C73`;
        document.getElementById('iframe-list').src = `https://calendar.google.com/calendar/u/0/embed?mode=AGENDA${src}${p}`;
        document.getElementById('iframe-week').src = `https://calendar.google.com/calendar/u/0/embed?mode=WEEK${src}${p}`;
    }

    function switchView(v) {
        currentTab = v;
        document.querySelectorAll('.view-pane, .t-btn').forEach(el => el.classList.remove('active'));
        document.getElementById('pane-'+v).classList.add('active');
        document.getElementById('btn-'+v).classList.add('active');
        const isCal = (v === 'week' || v === 'list');
        document.getElementById('prev-week').style.display = isCal ? 'flex' : 'none';
        document.getElementById('next-week').style.display = isCal ? 'flex' : 'none';
        document.getElementById('fab').style.display = (v === 'chores' || v === 'term') ? 'flex' : 'none';
    }

    // INITIALIZATION
    setInterval(() => { document.getElementById('time').textContent = new Date().toLocaleTimeString('en-AU', { hour: '2-digit', minute: '2-digit', hour12: true }).toLowerCase(); }, 1000);
    
    // Auto-update weather logic from V74
    async function fetchWeather() {
        try {
            const r = await fetch('https://api.open-meteo.com/v1/forecast?latitude=-37.76&longitude=144.90&current=temperature_2m,weather_code&daily=temperature_2m_max,temperature_2m_min&timezone=Australia/Melbourne');
            const d = await r.json();
            const codes = { 0: '‚òÄÔ∏è', 1: 'üå§Ô∏è', 2: '‚õÖ', 3: '‚òÅÔ∏è', 61: 'üåßÔ∏è', 80: 'üå¶Ô∏è' };
            const curr = Math.round(d.current.temperature_2m);
            const high = Math.round(d.daily.temperature_2m_max[0]);
            const low = Math.round(d.daily.temperature_2m_min[0]);
            document.getElementById('weather-display').innerHTML = `${codes[d.current.weather_code] || '‚òÄÔ∏è'} ${curr}¬∞ (L:${low}¬∞ H:${high}¬∞) ABERFELDIE`;
        } catch(e) {}
    }

    window.onload = () => {
        updateOverlayButtons();
        updateCals();
        fetchWeather();
        cloudLoad();
        setInterval(fetchWeather, 900000); 
        setInterval(cloudLoad, 30000);
    };
</script>
